# InstaCommand Backend Setup Guide

This guide explains how to set up the Supabase backend for InstaCommand.

## Overview

The backend consists of:
1. **Database Schema** - Multi-tenant workspace model with tables for users, workspaces, Instagram accounts, scheduled posts, analytics, and alerts
2. **RPC Functions** - Server-side functions for signup, user management, dashboard data, and account details
3. **Edge Functions** - Background jobs for processing scheduled posts and generating analytics snapshots
4. **Row Level Security (RLS)** - Policies ensuring users can only access their own workspace data

## Step 1: Run Migrations

1. Open Supabase Dashboard → SQL Editor
2. Run migrations in order:
   - `20250101000000_workspace_multi_tenant.sql` - Creates all tables and RLS policies
   - `20250101000001_rpc_functions.sql` - Creates RPC functions
   - `20250101000002_cron_setup.sql` - Documentation for cron setup (no SQL to run)

Or use Supabase CLI:
```bash
supabase db push
```

## Step 2: Deploy Edge Functions

### Deploy process_scheduled_posts

```bash
supabase functions deploy process_scheduled_posts
```

This function:
- Runs every 5 minutes
- Processes scheduled posts that are due
- Updates post status to "published"
- Creates post_performance entries with simulated metrics

### Deploy daily_analytics_snapshot

```bash
supabase functions deploy daily_analytics_snapshot
```

This function:
- Runs once per day (recommended: 2 AM UTC)
- Creates analytics snapshots for all accounts
- Generates alerts for engagement drops and low posting frequency

## Step 3: Set Up Cron Jobs

### Option A: Supabase Dashboard (Recommended)

1. Go to **Database → Cron Jobs** in Supabase Dashboard
2. Create cron job for `process_scheduled_posts`:
   - **Name**: `process-scheduled-posts`
   - **Schedule**: `*/5 * * * *` (every 5 minutes)
   - **SQL**:
   ```sql
   SELECT net.http_post(
       url := 'https://YOUR_PROJECT_REF.supabase.co/functions/v1/process_scheduled_posts',
       headers := jsonb_build_object(
           'Content-Type', 'application/json',
           'Authorization', 'Bearer YOUR_SERVICE_ROLE_KEY'
       ),
       body := '{}'::jsonb
   ) as request_id;
   ```

3. Create cron job for `daily_analytics_snapshot`:
   - **Name**: `daily-analytics-snapshot`
   - **Schedule**: `0 2 * * *` (daily at 2 AM UTC)
   - **SQL**:
   ```sql
   SELECT net.http_post(
       url := 'https://YOUR_PROJECT_REF.supabase.co/functions/v1/daily_analytics_snapshot',
       headers := jsonb_build_object(
           'Content-Type', 'application/json',
           'Authorization', 'Bearer YOUR_SERVICE_ROLE_KEY'
       ),
       body := '{}'::jsonb
   ) as request_id;
   ```

### Option B: pg_cron Extension

If `pg_cron` extension is enabled, you can use the SQL in `20250101000002_cron_setup.sql` (uncomment and modify with your project details).

## Step 4: Update Frontend Integration

Update your frontend hooks to use the new workspace-based schema:

### Sign Up Flow

After user signs up with Supabase Auth, call:

```typescript
const { data, error } = await supabase.rpc('signup_bootstrap', {
  workspace_name: 'My Workspace'
});
```

This will:
- Create a user record
- Create a workspace
- Add user as Owner
- Create a Free plan subscription

### Get Current User Data

```typescript
const { data, error } = await supabase.rpc('me');
// Returns: { user, workspaces, active_subscription }
```

### Get Dashboard Overview

```typescript
const { data, error } = await supabase.rpc('dashboard_overview', {
  p_workspace_id: workspaceId
});
```

### Get Account Details

```typescript
const { data, error } = await supabase.rpc('get_instagram_account_details', {
  p_account_id: accountId
});
```

## API Endpoints

### REST API (Auto-generated by Supabase)

All tables are exposed via REST API with RLS protection:

- `GET /rest/v1/workspaces` - List workspaces (filtered by RLS)
- `GET /rest/v1/instagram_accounts?workspace_id=eq.{id}` - List accounts
- `GET /rest/v1/scheduled_posts?workspace_id=eq.{id}` - List scheduled posts
- `POST /rest/v1/scheduled_posts` - Create scheduled post
- `GET /rest/v1/alerts?workspace_id=eq.{id}` - List alerts
- `PATCH /rest/v1/alerts?id=eq.{id}` - Update alert (mark as read)

### RPC Functions

- `signup_bootstrap(workspace_name TEXT)` - Initialize user, workspace, subscription
- `me()` - Get current user with workspaces and subscription
- `current_workspace()` - Get active workspace for current user
- `dashboard_overview(p_workspace_id UUID)` - Get dashboard stats
- `get_instagram_account_details(p_account_id UUID)` - Get account details with analytics
- `invite_member(p_workspace_id UUID, p_email TEXT, p_role TEXT)` - Invite team member

## Database Schema

### Core Tables

- `users` - Application users linked to `auth.users`
- `workspaces` - Multi-tenant workspaces
- `workspace_users` - Many-to-many relationship (users ↔ workspaces)
- `subscription_plans` - Pre-seeded plans (Free, Pro, Agency, Enterprise)
- `subscriptions` - Workspace subscriptions

### Instagram Tables

- `instagram_accounts` - Connected Instagram accounts (linked to workspace)
- `scheduled_posts` - Posts scheduled for publishing
- `analytics_snapshots` - Daily snapshots of account metrics
- `post_performances` - Performance data for individual posts
- `alerts` - System alerts (engagement drops, low posting, etc.)

## Security

All tables have Row Level Security (RLS) enabled. Users can only:
- Access data for workspaces they belong to
- View/update their own user record
- Access accounts, posts, and analytics within their workspaces

The `user_has_workspace_access()` function is used throughout RLS policies to ensure multi-tenant isolation.

## Testing

1. **Test Signup Flow**:
   ```sql
   -- After signing up via frontend, verify:
   SELECT * FROM public.users WHERE auth_user_id = auth.uid();
   SELECT * FROM public.workspaces;
   SELECT * FROM public.workspace_users;
   SELECT * FROM public.subscriptions;
   ```

2. **Test RPC Functions**:
   ```sql
   SELECT public.me();
   SELECT public.dashboard_overview('workspace-id-here');
   ```

3. **Test Edge Functions**:
   - Manually invoke via Supabase Dashboard → Edge Functions
   - Or use curl:
   ```bash
   curl -X POST https://YOUR_PROJECT_REF.supabase.co/functions/v1/process_scheduled_posts \
     -H "Authorization: Bearer YOUR_ANON_KEY"
   ```

## Troubleshooting

### RLS Issues
- Verify user is authenticated: `SELECT auth.uid();`
- Check workspace access: `SELECT public.user_has_workspace_access('workspace-id');`

### Edge Function Issues
- Check function logs in Supabase Dashboard
- Verify `SUPABASE_SERVICE_ROLE_KEY` is set in function secrets
- Ensure cron jobs are using correct function URLs

### Migration Issues
- Run migrations in order
- Check for existing columns before adding new ones
- Verify foreign key constraints are correct

## Next Steps

1. **Instagram API Integration**: Replace simulated post publishing with real Instagram Graph API calls
2. **Email Notifications**: Add email sending for alerts and invitations
3. **Webhooks**: Set up webhooks for Instagram API callbacks
4. **Advanced Analytics**: Add more sophisticated engagement score calculations
5. **Rate Limiting**: Implement rate limiting for API calls

